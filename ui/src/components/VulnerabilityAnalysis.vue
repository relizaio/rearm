<template>
    <div>
        <h4>Vulnerability Analysis</h4>
        <n-spin :show="loading">
            <n-space vertical>
                <n-data-table
                    :columns="columns"
                    :data="analysisRecords"
                    :pagination="{ pageSize: 20 }"
                    :row-key="(row: any) => row.uuid"
                />
            </n-space>
        </n-spin>
    </div>
</template>

<script lang="ts">
export default {
    name: 'VulnerabilityAnalysis'
}
</script>

<script lang="ts" setup>
import { ref, computed, onMounted, h, ComputedRef } from 'vue'
import { NSpin, NDataTable, NTag, NSpace, NTooltip, NIcon, DataTableColumns } from 'naive-ui'
import { Info20Regular } from '@vicons/fluent'
import gql from 'graphql-tag'
import graphqlClient from '@/utils/graphql'
import { useStore } from 'vuex'
import { useNotification, NotificationType } from 'naive-ui'

const store = useStore()
const notification = useNotification()
const loading = ref(false)
const analysisRecords = ref<any[]>([])

const myorg: ComputedRef<any> = computed((): any => store.getters.myorg)

const notify = async function (type: NotificationType, title: string, content: string) {
    notification[type]({
        content: content,
        meta: title,
        duration: 3500,
        keepAliveOnHover: true
    })
}

const columns: DataTableColumns<any> = [
    {
        title: 'Finding ID',
        key: 'findingId',
        width: 180,
        render: (row: any) => {
            const findingId = h('span', {}, row.findingId)
            
            if (row.findingAliases && row.findingAliases.length > 0) {
                const aliasesText = 'Aliases: ' + row.findingAliases.join(', ')
                const infoIcon = h(NTooltip, {
                    trigger: 'hover'
                }, {
                    trigger: () => h(NIcon, {
                        style: 'margin-left: 6px; cursor: pointer;',
                        size: 16
                    }, () => h(Info20Regular)),
                    default: () => aliasesText
                })
                
                return h('div', { style: 'display: flex; align-items: center;' }, [findingId, infoIcon])
            }
            
            return findingId
        }
    },
    {
        title: 'Finding Type',
        key: 'findingType',
        width: 140,
        render: (row: any) => {
            return h(NTag, { type: 'info', size: 'small' }, { default: () => row.findingType })
        }
    },
    {
        title: 'Location',
        key: 'location',
        minWidth: 200,
        ellipsis: { tooltip: true }
    },
    {
        title: 'Location Type',
        key: 'locationType',
        width: 120,
        render: (row: any) => {
            return h(NTag, { type: 'success', size: 'small' }, { default: () => row.locationType })
        }
    },
    {
        title: 'Scope',
        key: 'scope',
        width: 120,
        render: (row: any) => {
            return h(NTag, { type: 'info', size: 'small' }, { default: () => row.scope })
        }
    },
    {
        title: 'Scope UUID',
        key: 'scopeUuid',
        width: 200,
        ellipsis: { tooltip: true }
    },
    {
        title: 'Current State',
        key: 'analysisState',
        width: 150,
        render: (row: any) => {
            const stateColors: any = {
                EXPLOITABLE: 'error',
                IN_TRIAGE: 'warning',
                FALSE_POSITIVE: 'success',
                NOT_AFFECTED: 'info'
            }
            
            const tag = h(NTag, { 
                type: stateColors[row.analysisState] || 'default', 
                size: 'small' 
            }, { default: () => row.analysisState })
            
            if (row.analysisJustification) {
                const infoIcon = h(NTooltip, {
                    trigger: 'hover'
                }, {
                    trigger: () => h(NIcon, {
                        style: 'margin-left: 6px; cursor: pointer;',
                        size: 16
                    }, () => h(Info20Regular)),
                    default: () => "Justification: " + row.analysisJustification
                })
                
                return h('div', { style: 'display: flex; align-items: center;' }, [tag, infoIcon])
            }
            
            return tag
        }
    },
    {
        title: 'History',
        key: 'analysisHistory',
        minWidth: 300,
        render: (row: any) => {
            if (!row.analysisHistory || row.analysisHistory.length === 0) {
                return '-'
            }
            
            return h(NSpace, { vertical: true, size: 'small' }, {
                default: () => row.analysisHistory.map((history: any, index: number) => {
                    const stateColors: any = {
                        EXPLOITABLE: 'error',
                        IN_TRIAGE: 'warning',
                        FALSE_POSITIVE: 'success',
                        NOT_AFFECTED: 'info'
                    }
                    
                    const dateStr = history.createdDate 
                        ? new Date(history.createdDate).toLocaleString('en-CA', { hour12: false })
                        : 'Unknown'
                    
                    const justification = history.justification ? ` - ${history.justification}` : ''
                    const details = history.details ? ` (${history.details})` : ''
                    
                    const fullText = `${dateStr}${justification}${details}`
                    
                    return h(NTooltip, {
                        trigger: 'hover'
                    }, {
                        trigger: () => h('div', { key: index, style: 'font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;' }, [
                            h(NTag, { 
                                type: stateColors[history.state] || 'default', 
                                size: 'tiny',
                                style: 'margin-right: 4px;'
                            }, { default: () => history.state }),
                            h('span', {}, fullText)
                        ]),
                        default: () => fullText
                    })
                })
            })
        }
    }
]

const fetchAnalysisRecords = async () => {
    if (!myorg.value || !myorg.value.uuid) {
        notify('error', 'Error', 'No organization selected')
        return
    }
    
    loading.value = true
    try {
        const response = await graphqlClient.query({
            query: gql`
                query getVulnAnalysis($org: ID!) {
                    getVulnAnalysis(org: $org) {
                        uuid
                        org
                        location
                        locationType
                        findingId
                        findingAliases
                        findingType
                        scope
                        scopeUuid
                        analysisState
                        analysisJustification
                        analysisHistory {
                            state
                            justification
                            details
                            createdDate
                        }
                    }
                }
            `,
            variables: {
                org: myorg.value.uuid
            },
            fetchPolicy: 'no-cache'
        })
        
        analysisRecords.value = response.data.getVulnAnalysis || []
    } catch (error: any) {
        console.error('Error fetching vulnerability analysis records:', error)
        notify('error', 'Error', 'Failed to fetch vulnerability analysis records')
        analysisRecords.value = []
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchAnalysisRecords()
})
</script>

<style scoped>
h4 {
    margin-bottom: 20px;
}
</style>
