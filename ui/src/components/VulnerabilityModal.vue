<template>
    <n-modal
        v-model:show="isVisible"
        :title="modalTitle"
        style="width: 95%;"
        preset="dialog"
        :show-icon="false"
    >
        <n-spin :show="loading">
            <n-data-table
                :columns="vulnerabilityColumns"
                :data="data"
                :row-key="rowKey"
                :pagination="{ pageSize: 10 }"
            />
        </n-spin>
    </n-modal>
</template>

<script lang="ts">
export default {
    name: 'VulnerabilityModal'
}
</script>

<script lang="ts" setup>
import { computed, ComputedRef, h } from 'vue'
import { NModal, NSpin, NDataTable, NTag, NTooltip, NIcon, DataTableColumns } from 'naive-ui'
import { RouterLink } from 'vue-router'
import { buildVulnerabilityColumns } from '@/utils/metrics'
import { ReleaseVulnerabilityService } from '@/utils/releaseVulnerabilityService'

interface Props {
    show: boolean
    componentName?: string
    version?: string
    artifactDisplayId?: string
    data: any[]
    loading?: boolean
    artifacts?: any[]
    orgUuid?: string
    dtrackProjectUuids?: string[]
    rowKey?: (row: any) => string
}

const props = withDefaults(defineProps<Props>(), {
    loading: false,
    componentName: '',
    version: '',
    artifactDisplayId: '',
    artifacts: () => [],
    orgUuid: '',
    dtrackProjectUuids: () => [],
    rowKey: (row: any) => row.type + '-' + row.id + '-' + row.purl
})

const emit = defineEmits<{
    'update:show': [value: boolean]
}>()

const isVisible = computed({
    get: () => props.show,
    set: (value: boolean) => emit('update:show', value)
})

const modalTitle: ComputedRef<string> = computed(() => {
    // If artifactDisplayId is provided, show artifact-specific title
    if (props.artifactDisplayId) {
        return `Findings for artifact: ${props.artifactDisplayId}`
    }
    // Otherwise, show release-specific title
    return `Findings for release: ${props.componentName}, version ${props.version}`
})

const vulnerabilityColumns: DataTableColumns<any> = buildVulnerabilityColumns(h, NTag, NTooltip, NIcon, RouterLink, {
    hasKnownDependencyTrackIntegration: () => ReleaseVulnerabilityService.hasKnownDependencyTrackIntegration(props.artifacts),
    getArtifacts: () => props.artifacts,
    getOrgUuid: () => props.orgUuid,
    getDtrackProjectUuids: () => props.dtrackProjectUuids
})
</script>
