<template>
    <n-modal
        v-model:show="isVisible"
        style="width: 95%;"
        preset="dialog"
        :show-icon="false"
    >
        <template #header>
            <component :is="modalTitle" />
        </template>
        <n-space vertical>
            <n-space align="center" justify="space-between" style="width: 100%;">
                <n-space align="center">
                    <span>Show Suppressed:</span>
                    <n-switch v-model:value="showSuppressed" />
                    <n-text depth="3" style="font-size: 12px;">
                        ({{ suppressedCount }} suppressed)
                    </n-text>
                    <n-divider vertical />
                    <span>Show Unsuppressed:</span>
                    <n-switch v-model:value="showUnsuppressed" />
                    <n-text depth="3" style="font-size: 12px;">
                        ({{ unsuppressedCount }} unsuppressed)
                    </n-text>
                </n-space>
                <n-button @click="exportToPdf" type="primary" size="small">
                    <template #icon>
                        <n-icon><DocumentPdf20Regular /></n-icon>
                    </template>
                    Export PDF
                </n-button>
            </n-space>
            <n-spin :show="loading">
                <n-data-table
                    :columns="vulnerabilityColumns"
                    :data="filteredData"
                    :row-key="rowKey"
                    :pagination="{ pageSize: 10 }"
                />
            </n-spin>
        </n-space>
    </n-modal>
    
    <create-vuln-analysis-modal
        v-model:show="showCreateAnalysisModal"
        :finding-row="selectedFinding"
        :org-uuid="orgUuid"
        :release-uuid="releaseUuid"
        :branch-uuid="branchUuid"
        :branch-name="branchName"
        :component-uuid="componentUuid"
        :component-name="componentName"
        :component-type="componentType"
        :release-version="version"
        :artifact-view-only="artifactViewOnly"
        @created="onAnalysisCreated"
    />
    
    <view-vuln-analysis-modal
        v-model:show="showViewAnalysisModal"
        :org-uuid="orgUuid"
        :location="viewAnalysisLocation"
        :finding-id="viewAnalysisFindingId"
        :finding-type="viewAnalysisFindingType"
        :finding-aliases="viewAnalysisAliases"
        :severity="viewAnalysisSeverity"
        :release-uuid="releaseUuid"
        :branch-uuid="branchUuid"
        :branch-name="branchName"
        :component-uuid="componentUuid"
        :component-name="componentName"
        :component-type="componentType"
        :release-version="version"
        :artifact-view-only="artifactViewOnly"
        @analysis-changed="onAnalysisChanged"
    />
    
    <n-modal
        v-model:show="showPdfExportModal"
        title="PDF Export Settings"
        preset="dialog"
        :show-icon="false"
        style="width: 500px;"
    >
        <n-space vertical>
            <n-form-item label="Type">
                <n-checkbox-group v-model:value="pdfExportTypes">
                    <n-space>
                        <n-checkbox value="Vulnerability">Vulnerabilities</n-checkbox>
                        <n-checkbox value="Violation">Violations</n-checkbox>
                        <n-checkbox value="Weakness">Weaknesses</n-checkbox>
                    </n-space>
                </n-checkbox-group>
            </n-form-item>
            <n-form-item label="Severity">
                <n-checkbox-group v-model:value="pdfExportSeverities">
                    <n-space>
                        <n-checkbox value="CRITICAL">Critical</n-checkbox>
                        <n-checkbox value="HIGH">High</n-checkbox>
                        <n-checkbox value="MEDIUM">Medium</n-checkbox>
                        <n-checkbox value="LOW">Low</n-checkbox>
                        <n-checkbox value="UNASSIGNED">Unassigned</n-checkbox>
                    </n-space>
                </n-checkbox-group>
            </n-form-item>
            <n-form-item label="Include Analysis">
                <n-switch v-model:value="pdfIncludeAnalysis" />
            </n-form-item>
            <n-form-item label="Include Suppressed">
                <n-switch v-model:value="pdfIncludeSuppressed" />
            </n-form-item>
            <n-space justify="end">
                <n-button @click="showPdfExportModal = false">Cancel</n-button>
                <n-button type="primary" @click="executeExportToPdf">
                    <template #icon>
                        <n-icon><DocumentPdf20Regular /></n-icon>
                    </template>
                    Export
                </n-button>
            </n-space>
        </n-space>
    </n-modal>
</template>

<script lang="ts">
export default {
    name: 'VulnerabilityModal'
}
</script>

<script lang="ts" setup>
import { computed, ComputedRef, h, ref } from 'vue'
import { useStore } from 'vuex'
import { NModal, NSpin, NDataTable, NTag, NTooltip, NIcon, NSwitch, NSpace, NText, NButton, NCheckboxGroup, NCheckbox, NFormItem, NDivider, DataTableColumns, useNotification } from 'naive-ui'
import { RouterLink, useRouter } from 'vue-router'
import { ExternalLink, Refresh } from '@vicons/tabler'
import { DocumentPdf20Regular } from '@vicons/fluent'
import { buildVulnerabilityColumns } from '@/utils/metrics'
import { ReleaseVulnerabilityService } from '@/utils/releaseVulnerabilityService'
import { exportFindingsToPdf } from '@/utils/pdfExport'
import CreateVulnAnalysisModal from './CreateVulnAnalysisModal.vue'
import ViewVulnAnalysisModal from './ViewVulnAnalysisModal.vue'

interface Props {
    show: boolean
    componentName?: string
    version?: string
    artifactDisplayId?: string
    data: any[]
    loading?: boolean
    artifacts?: any[]
    orgUuid?: string
    dtrackProjectUuids?: string[]
    releaseUuid?: string
    branchUuid?: string
    branchName?: string
    componentUuid?: string
    componentType?: string
    artifactViewOnly?: boolean
    rowKey?: (row: any) => string
    initialSeverityFilter?: string
    initialTypeFilter?: string
    showRefreshAction?: boolean
    onRefreshAction?: () => void
}

const props = withDefaults(defineProps<Props>(), {
    loading: false,
    componentName: '',
    version: '',
    artifactDisplayId: '',
    artifacts: () => [],
    orgUuid: '',
    dtrackProjectUuids: () => [],
    releaseUuid: '',
    branchUuid: '',
    branchName: '',
    componentUuid: '',
    componentType: '',
    artifactViewOnly: false,
    rowKey: (row: any) => row.type + '-' + row.id + '-' + row.purl,
    initialSeverityFilter: '',
    initialTypeFilter: '',
    showRefreshAction: false,
    onRefreshAction: undefined
})

const emit = defineEmits<{
    'update:show': [value: boolean]
    'edit-finding': [row: any]
    'refresh-data': []
}>()

const isVisible = computed({
    get: () => props.show,
    set: (value: boolean) => emit('update:show', value)
})

const modalTitle = computed(() => {
    return () => {
        const titleText = (() => {
            // If artifactDisplayId is provided, show artifact-specific title
            if (props.artifactDisplayId) {
                return `Findings for artifact: ${props.artifactDisplayId}`
            }
            // If componentName starts with "Findings for", use it directly (custom title)
            if (props.componentName.startsWith('Findings for')) {
                return props.componentName
            }
            // Otherwise, show release-specific title
            return `Findings for release: ${props.componentName}, version ${props.version}`
        })()
        
        // Add icon link if we have context for vulnerability analysis (release, or component/branch)
        const hasContext = props.orgUuid && (props.releaseUuid || props.componentUuid || props.branchUuid)
        const icons: any[] = []
        
        if (hasContext) {
            icons.push(h(NIcon, {
                size: 18,
                style: 'cursor: pointer; color: #18a058;',
                title: 'Open Finding Analysis',
                onClick: () => {
                    const query: Record<string, string> = {}
                    if (props.releaseUuid) query.release = props.releaseUuid
                    if (props.componentUuid) query.componentProduct = props.componentUuid
                    if (props.branchUuid) query.branchFeatureSet = props.branchUuid
                    if (props.componentType) query.type = props.componentType
                    
                    router.push({
                        name: 'VulnerabilityAnalysis',
                        params: { orguuid: props.orgUuid },
                        query
                    })
                }
            }, { default: () => h(ExternalLink) }))
        }
        
        if (props.showRefreshAction && props.onRefreshAction) {
            icons.push(h(NIcon, {
                size: 18,
                style: 'cursor: pointer; color: #2080f0;',
                title: 'Refresh Analytics Metrics for Date',
                onClick: props.onRefreshAction
            }, { default: () => h(Refresh) }))
        }
        
        if (icons.length > 0) {
            return h('div', { style: 'display: flex; align-items: center; gap: 8px;' }, [
                h('span', titleText),
                ...icons
            ])
        }
        
        return h('span', titleText)
    }
})

const store = useStore()
const router = useRouter()
const notification = useNotification()
const myorg = computed(() => store.getters.myorg)
const showCreateAnalysisModal = ref(false)
const selectedFinding = ref<any>(null)
const showSuppressed = ref(false)
const showUnsuppressed = ref(true)
const showPdfExportModal = ref(false)
const pdfExportTypes = ref(['Vulnerability', 'Violation', 'Weakness'])
const pdfExportSeverities = ref(['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNASSIGNED'])
const pdfIncludeAnalysis = ref(false)
const pdfIncludeSuppressed = ref(false)
const showViewAnalysisModal = ref(false)
const viewAnalysisLocation = ref('')
const viewAnalysisFindingId = ref('')
const viewAnalysisFindingType = ref('')
const viewAnalysisAliases = ref<any[]>([])
const viewAnalysisSeverity = ref('')

const isSuppressed = (row: any): boolean => {
    const state = row.analysisState
    return state === 'FALSE_POSITIVE' || state === 'NOT_AFFECTED'
}

const filteredData = computed(() => {
    let data = props.data
    
    // Apply suppressed filter
    if (!showSuppressed.value) {
        data = data.filter(row => !isSuppressed(row))
    }
    
    // Apply unsuppressed filter
    if (!showUnsuppressed.value) {
        data = data.filter(row => isSuppressed(row))
    }
    
    return data
})

const suppressedCount = computed(() => {
    return props.data.filter(row => isSuppressed(row)).length
})

const unsuppressedCount = computed(() => {
    return props.data.filter(row => !isSuppressed(row)).length
})

const handleEditFinding = (row: any) => {
    selectedFinding.value = row
    showCreateAnalysisModal.value = true
}

const handleViewAnalysis = (row: any) => {
    viewAnalysisLocation.value = row.purl || row.location || ''
    viewAnalysisFindingId.value = row.id || ''
    viewAnalysisFindingType.value = row.type?.toUpperCase() || 'VULNERABILITY'
    viewAnalysisAliases.value = row.aliases || []
    viewAnalysisSeverity.value = row.severity || ''
    showViewAnalysisModal.value = true
}

const onAnalysisCreated = (analysis: any) => {
    // Success notification is handled by the child component
    emit('refresh-data')
}

const onAnalysisChanged = () => {
    emit('refresh-data')
}

const vulnerabilityColumns = computed(() => buildVulnerabilityColumns(h, NTag, NTooltip, NIcon, RouterLink, {
    hasKnownDependencyTrackIntegration: () => ReleaseVulnerabilityService.hasKnownDependencyTrackIntegration(props.artifacts),
    getArtifacts: () => props.artifacts,
    getOrgUuid: () => props.orgUuid,
    getDtrackProjectUuids: () => props.dtrackProjectUuids,
    onEditFinding: handleEditFinding,
    onViewAnalysis: handleViewAnalysis,
    initialSeverityFilter: props.initialSeverityFilter,
    initialTypeFilter: props.initialTypeFilter,
    data: props.data
}))

// PDF Export functionality
function exportToPdf() {
    // Reset to defaults and show modal
    pdfExportTypes.value = ['Vulnerability', 'Violation', 'Weakness']
    pdfExportSeverities.value = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNASSIGNED']
    pdfIncludeAnalysis.value = false
    pdfIncludeSuppressed.value = false
    showPdfExportModal.value = true
}

function executeExportToPdf() {
    // Build title
    let title = 'Findings Report'
    if (props.artifactDisplayId) {
        title = `Findings for artifact: ${props.artifactDisplayId}`
    } else if (props.componentName) {
        if (props.componentName.startsWith('Findings for')) {
            title = props.componentName
        } else {
            title = `Findings for release: ${props.componentName}${props.version ? `, version ${props.version}` : ''}`
        }
    }

    const result = exportFindingsToPdf({
        data: props.data,
        title,
        orgName: myorg.value?.name || 'Unknown',
        types: pdfExportTypes.value,
        severities: pdfExportSeverities.value,
        includeAnalysis: pdfIncludeAnalysis.value,
        includeSuppressed: pdfIncludeSuppressed.value,
        filenamePrefix: 'findings'
    })

    if (!result.success) {
        notification.warning({
            title: 'No Data',
            content: result.message || 'No findings match the selected filters',
            duration: 3000
        })
        return
    }

    showPdfExportModal.value = false
}
</script>
